<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë¼í”Œ ì§€ë¢°ì°¾ê¸° - ìµœì¢… í†µí•©ë³¸</title>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ë° ì‹œìŠ¤í…œ ê°„ì„­ ì°¨ë‹¨ */
        body { 
            background-color: #008080; display: flex; flex-direction: column; justify-content: center; align-items: center; 
            min-height: 100vh; margin: 0; font-family: 'Tahoma', sans-serif;
            -webkit-touch-callout: none; -webkit-user-select: none; user-select: none;
            touch-action: none; /* ë¸Œë¼ìš°ì € ê¸°ë³¸ ì œìŠ¤ì²˜ ì°¨ë‹¨ */
        }
        .window { 
            background-color: #c0c0c0; border: 3px solid; border-color: #ffffff #808080 #808080 #ffffff; 
            padding: 20px; text-align: center; box-shadow: 5px 5px 15px rgba(0,0,0,0.3); min-width: 320px; 
            margin-bottom: 20px; box-sizing: border-box; z-index: 10;
        }
        .hidden { display: none !important; }
        h1 { font-size: 22px; margin: 0 0 15px 0; color: #000080; }
        h2 { font-size: 18px; margin: 0 0 10px 0; color: #000080; }
        p { font-size: 14px; margin-bottom: 20px; line-height: 1.5; }
        
        button { 
            display: block; width: 100%; padding: 10px; margin: 8px 0; 
            background: #c0c0c0; border: 2px solid; border-color: #fff #808080 #808080 #fff;
            font-weight: bold; cursor: pointer; font-size: 14px;
        }
        button:active { border-color: #808080 #fff #fff #808080; background: #d0d0d0; }

        /* ê²Œì„ ë³´ë“œ */
        #game-board { display: grid; border: 3px inset #ffffff; background-color: #808080; margin: 0 auto; touch-action: none; }
        .cell { 
            width: 32px; height: 32px; background-color: #c0c0c0; border: 3px solid; 
            border-color: #ffffff #808080 #808080 #ffffff; 
            display: flex; align-items: center; justify-content: center; 
            font-weight: bold; cursor: pointer; font-size: 16px; box-sizing: border-box; 
        }
        .cell.open { border: 1px solid #7b7b7b; background-color: #bdbdbd; border-width: 0.5px; }
        .n1 { color: blue; } .n2 { color: green; } .n3 { color: red; } .n4 { color: darkblue; }
        
        #status-bar { display: flex; justify-content: space-between; padding: 5px; background: #c0c0c0; border: 2px inset #fff; margin-bottom: 10px; font-weight: bold; }
        #count-num { font-size: 80px; color: #000080; margin: 10px 0; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; font-size: 13px; }
        th, td { border: 1px solid #808080; padding: 5px; text-align: center; }
        
        .ad-banner { 
            width: 90%; max-width: 350px; background: #fff; border-radius: 12px; padding: 12px; 
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); text-decoration: none; border: 2px solid #00ce7c;
            position: relative; z-index: 5;
        }
        .ad-disabled { pointer-events: none; opacity: 0.6; }
        .ad-text { color: #333; font-size: 13px; font-weight: bold; text-align: left; }
        .ad-go { background:#00ce7c; color:#fff; padding:5px 10px; border-radius:15px; font-size:12px; font-weight:bold; }
    </style>
</head>
<body>

    <div id="screen-intro" class="window">
        <h1>ì¶”ì–µì˜ ì§€ë¢°ì°¾ê¸°</h1>
        <p>ê³ ë„ì˜ ë‘ë‡Œê²Œì„<br>ë§¤ì¼ ì§€ë¢°ì°¾ê¸° í•˜ê³ <br>ë‚˜ì˜ ë‡Œë¥¼ ê¹¨ìš°ì„¸ìš”!</p>
        <button onclick="showScreen('screen-difficulty')">ê²Œì„ ì‹œì‘í•˜ê¸°</button>
        <button onclick="openRanking()">ë­í‚¹ë³´ê¸°</button>
    </div>

    <div id="screen-difficulty" class="window hidden">
        <h1>ë‚œì´ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”</h1>
        <button onclick="prepareGame(9, 9, 10, 'ì‰¬ì›€')">ì‰¬ì›€ (9x9)</button>
        <button onclick="prepareGame(12, 12, 20, 'ë³´í†µ')">ë³´í†µ (12x12)</button>
        <button onclick="prepareGame(16, 12, 35, 'ì–´ë ¤ì›€')">ì–´ë ¤ì›€ (12x16)</button>
        <button onclick="showScreen('screen-intro')" style="margin-top: 15px;">ë’¤ë¡œê°€ê¸°</button>
    </div>

    <div id="screen-countdown" class="window hidden">
        <h1>ì¤€ë¹„í•˜ì„¸ìš”!</h1>
        <div id="count-num">3</div>
        <p><span id="count-text">3</span>ì´ˆ ë’¤ì— ê²Œì„ì´ ì‹œì‘ë©ë‹ˆë‹¤.</p>
    </div>

    <div id="screen-game" class="window hidden">
        <h2>ë¼í”Œ ì§€ë¢°ì°¾ê¸°</h2>
        <div id="status-bar">
            <span>ğŸ’£ <span id="mine-count">0</span></span>
            <span>â±ï¸ <span id="timer">0</span></span>
        </div>
        <div id="game-board"></div>
    </div>

    <div id="screen-fail" class="window hidden">
        <h1>ğŸ’¥ ì½°ê´‘!</h1>
        <p>ì§€ë¢°ë¥¼ ë°Ÿì•˜ìŠµë‹ˆë‹¤!</p>
        <button onclick="restartGame()">ë‹¤ì‹œ ì‹œì‘</button>
        <button onclick="showScreen('screen-intro')">ê²Œì„ ì¢…ë£Œ</button>
    </div>

    <div id="screen-success" class="window hidden">
        <h1>ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤!</h1>
        <p>ê¸°ë¡: <span id="final-time">0</span>ì´ˆ</p>
        <input type="text" id="nickname" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" style="padding:10px; width:80%; margin-bottom:10px; border:2px inset #fff; text-align: center;">
        <button id="save-btn" onclick="saveRecord()">ê¸°ë¡ ì €ì¥</button>
    </div>

    <div id="screen-ranking" class="window hidden">
        <h1>ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</h1>
        <div style="display:flex; gap:5px; margin-bottom:10px;">
            <button onclick="loadRankingFromServer('ì‰¬ì›€')" style="font-size:11px;">ì‰¬ì›€</button>
            <button onclick="loadRankingFromServer('ë³´í†µ')" style="font-size:11px;">ë³´í†µ</button>
            <button onclick="loadRankingFromServer('ì–´ë ¤ì›€')" style="font-size:11px;">ì–´ë ¤ì›€</button>
        </div>
        <table>
            <thead><tr><th>ìˆœìœ„</th><th>ë‹‰ë„¤ì„</th><th>ê¸°ë¡</th></tr></thead>
            <tbody id="rank-body"></tbody>
        </table>
        <button onclick="showScreen('screen-intro')" style="margin-top: 15px;">ë©”ì¸ìœ¼ë¡œ</button>
    </div>

    <a id="footer-ad" href="https://m.lifeplanet.co.kr:444/lpds2/insurance/term-life-insurance.dev" target="_blank" class="ad-banner">
        <div class="ad-text">ìš°ë¦¬ê°€ì¡±ì„ ìœ„í•œ ì‚¬ë§ì¤€ë¹„<br>êµë³´ë¼í”Œ ì •ê¸°ë³´í—˜</div>
        <div class="ad-go">ì´ë™</div>
    </a>

<script>
    // â˜… ë³¸ì¸ì˜ GAS URLì„ ì—¬ê¸°ì— ë„£ìœ¼ì„¸ìš”
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwbrf6Jf9gsE-btNXi7WLV8FsIRioETXU7ZV3gKZt_Bqto649RgUV0OOgi8lz1xcW15/exec";

    let rows, cols, mines, currentMode, timerInterval, time, boardData, revealedCount, gameOver;

    function getCookie(name) {
        let value = "; " + document.cookie;
        let parts = value.split("; " + name + "=");
        if (parts.length === 2) return parts.pop().split(";").shift();
        return "GUEST_USER"; 
    }

    function showScreen(screenId) {
        // ëª¨ë“  í™”ë©´ ìˆ¨ê¸°ê¸°
        document.querySelectorAll('.window').forEach(w => w.classList.add('hidden'));
        
        // ëŒ€ìƒ í™”ë©´ í‘œì‹œ
        const target = document.getElementById(screenId);
        target.classList.remove('hidden');

        // ê²Œì„ í™”ë©´ì—ì„œë§Œ ê´‘ê³  í´ë¦­ í—ˆìš© (íŠ•ê¹€ ë°©ì§€)
        const ad = document.getElementById('footer-ad');
        if (screenId === 'screen-game') {
            ad.classList.remove('ad-disabled');
        } else {
            ad.classList.add('ad-disabled');
        }
    }

    function prepareGame(r, c, m, mode) {
        rows = r; cols = c; mines = m; currentMode = mode;
        showScreen('screen-countdown');
        let count = 3;
        const updateUI = (n) => { 
            document.getElementById('count-num').innerText = n; 
            document.getElementById('count-text').innerText = n; 
        };
        updateUI(count);
        const cdInterval = setInterval(() => {
            count--;
            if (count > 0) updateUI(count);
            else { clearInterval(cdInterval); startGame(); }
        }, 1000);
    }

    function startGame() {
        showScreen('screen-game');
        gameOver = false; revealedCount = 0; time = 0;
        document.getElementById('timer').innerText = 0;
        document.getElementById('mine-count').innerText = mines;
        createBoard();
        startTimer();
    }

    function createBoard() {
        const board = document.getElementById('game-board');
        board.style.gridTemplateColumns = `repeat(${cols}, 32px)`;
        board.innerHTML = '';
        boardData = Array.from({ length: rows }, () => Array.from({ length: cols }, () => ({ isMine: false, isOpen: false, count: 0 })));
        
        let planted = 0;
        while (planted < mines) {
            let rx = Math.floor(Math.random() * rows), ry = Math.floor(Math.random() * cols);
            if (!boardData[rx][ry].isMine) { boardData[rx][ry].isMine = true; planted++; }
        }

        for (let i = 0; i < rows; i++) {
            for (let j = 0; j < cols; j++) {
                if (boardData[i][j].isMine) continue;
                let cnt = 0;
                for (let x = -1; x <= 1; x++) {
                    for (let y = -1; y <= 1; y++) {
                        if (boardData[i+x] && boardData[i+x][j+y] && boardData[i+x][j+y].isMine) cnt++;
                    }
                }
                boardData[i][j].count = cnt;
            }
        }

        for (let i = 0; i < rows; i++) {
            for (let j = 0; j < cols; j++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.id = `cell-${i}-${j}`;
                
                let touchTimer = null;
                let isLong = false;

                // ëª¨ë°”ì¼ í„°ì¹˜ ì´ë²¤íŠ¸ ìµœì í™”
                cell.addEventListener('touchstart', (e) => {
                    if (gameOver || boardData[i][j].isOpen) return;
                    isLong = false;
                    touchTimer = setTimeout(() => {
                        toggleFlag(cell, i, j);
                        isLong = true;
                        if (window.navigator.vibrate) window.navigator.vibrate(40);
                    }, 500);
                }, { passive: true });

                cell.addEventListener('touchend', (e) => {
                    if (touchTimer) { clearTimeout(touchTimer); touchTimer = null; }
                    
                    // í•µì‹¬: ë¸Œë¼ìš°ì €ì˜ ê³ ìŠ¤íŠ¸ í´ë¦­ ë°©ì§€
                    e.preventDefault(); 
                    
                    if (!isLong) {
                        clickCell(i, j);
                    }
                }, false);

                // PC ë§ˆìš°ìŠ¤ ìš°í´ë¦­ ëŒ€ì‘
                cell.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    if (e.pointerType === 'mouse') toggleFlag(cell, i, j);
                });
                
                board.appendChild(cell);
            }
        }
    }

    function toggleFlag(el, x, y) {
        if (gameOver || boardData[x][y].isOpen) return;
        el.innerText = el.innerText === 'ğŸš©' ? '' : 'ğŸš©';
    }

    function clickCell(x, y) {
        if (gameOver) return;
        let data = boardData[x][y];
        const el = document.getElementById(`cell-${x}-${y}`);
        
        if (el.innerText === 'ğŸš©' || data.isOpen) return;

        if (data.isMine) {
            gameOver = true; 
            clearInterval(timerInterval);
            
            // ê´‘ê³  í´ë¦­ ì¦‰ì‹œ ì°¨ë‹¨
            document.getElementById('footer-ad').classList.add('ad-disabled');
            
            // ë¯¸ì„¸í•œ ì§€ì—° í›„ ì‹¤íŒ¨ í™”ë©´ í‘œì‹œ (ê³ ìŠ¤íŠ¸ í´ë¦­ ë°©ì§€)
            setTimeout(() => { showScreen('screen-fail'); }, 100);
            return;
        }
        
        reveal(x, y);
        
        if (revealedCount === (rows * cols) - mines) {
            gameOver = true; 
            clearInterval(timerInterval);
            document.getElementById('final-time').innerText = time;
            setTimeout(() => { showScreen('screen-success'); }, 100);
        }
    }

    function reveal(x, y) {
        if (!boardData[x] || !boardData[x][y] || boardData[x][y].isOpen) return;
        const el = document.getElementById(`cell-${x}-${y}`);
        if (el.innerText === 'ğŸš©') return;
        let data = boardData[x][y];
        data.isOpen = true; revealedCount++;
        el.classList.add('open');
        if (data.count > 0) { el.innerText = data.count; el.classList.add('n' + data.count); }
        else { for (let i = -1; i <= 1; i++) for (let j = -1; j <= 1; j++) reveal(x + i, y + j); }
    }

    function startTimer() { timerInterval = setInterval(() => { time++; document.getElementById('timer').innerText = time; }, 1000); }
    function restartGame() { prepareGame(rows, cols, mines, currentMode); }

    async function saveRecord() {
        const nick = document.getElementById('nickname').value || "ìµëª…";
        const uid = getCookie('UID');
        const btn = document.getElementById('save-btn');
        btn.disabled = true; btn.innerText = "ì €ì¥ ì¤‘...";
        try {
            await fetch(GAS_API_URL, { 
                method: "POST", 
                mode: "no-cors", // Vercelì—ì„œ GAS í˜¸ì¶œ ì‹œ í•„ìˆ˜
                body: JSON.stringify({ uid: uid, nickname: nick, time: time, mode: currentMode }) 
            });
            alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ë­í‚¹ì„ í™•ì¸í•˜ì„¸ìš”."); 
            openRanking();
        } catch (err) { alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"); btn.disabled = false; btn.innerText = "ê¸°ë¡ ì €ì¥"; }
    }

    async function loadRankingFromServer(mode) {
        const body = document.getElementById('rank-body');
        body.innerHTML = '<tr><td colspan="3">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>';
        try {
            const res = await fetch(`${GAS_API_URL}?mode=${encodeURIComponent(mode)}`);
            const data = await res.json();
            body.innerHTML = '';
            if (!data || data.length === 0) body.innerHTML = '<tr><td colspan="3">ê¸°ë¡ ì—†ìŒ</td></tr>';
            else data.forEach((r, i) => { body.innerHTML += `<tr><td>${i+1}</td><td>${r.nick}</td><td>${r.time}ì´ˆ</td></tr>`; });
        } catch (err) { body.innerHTML = '<tr><td colspan="3">ë°ì´í„° ì—ëŸ¬</td></tr>'; }
    }

    function openRanking() { showScreen('screen-ranking'); loadRankingFromServer(currentMode || 'ì‰¬ì›€'); }
</script>
</body>
</html>